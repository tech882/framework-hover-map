<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Framework Hover Map</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 16px; }
    #wrap { max-width: 1200px; margin: 0 auto; }
    #chart { position: relative; }
    svg { width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 10px; }
    .country { cursor: pointer; stroke: #fff; stroke-width: 0.4; }
    .tooltip {
      position: absolute;
      display: none;
      min-width: 260px;
      max-width: 360px;
      background: rgba(17, 24, 39, 0.96);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.35;
      pointer-events: none;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .tooltip .title { font-weight: 700; font-size: 13px; margin-bottom: 6px; }
    .row { display: flex; justify-content: space-between; gap: 10px; }
    .k { opacity: .8; }
    .v { font-weight: 600; text-align: right; }
    .links a { color: #93c5fd; text-decoration: none; word-break: break-all; }
    .links a:hover { text-decoration: underline; }
    .muted { opacity: .75; margin-top: 6px; font-size: 11px; }
    .legend { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 0; font-size: 12px; }
    .swatch { width: 12px; height: 12px; border-radius: 3px; display: inline-block; margin-right: 6px; border: 1px solid rgba(0,0,0,.12); }
  </style>
</head>
<body>
<div id="wrap">
  <h2>Waste & Circular Economy Frameworks — Hover Map (Demo)</h2>
  <p style="margin-top:-6px; color:#374151; max-width: 980px;">
    Hover a country to see an audit-safe summary. Colors represent <strong>Waste and ESG Frameworks</strong>.
  </p>

  <div class="legend" aria-label="Legend">
    <div><span class="swatch" style="background:#16a34a;"></span>EU_directive</div>
    <div><span class="swatch" style="background:#f59e0b;"></span>national_equivalent</div>
    <div><span class="swatch" style="background:#60a5fa;"></span>partial</div>
    <div><span class="swatch" style="background:#d1d5db;"></span>none</div>
  </div>

  <div id="chart">
    <div id="tooltip" class="tooltip" role="dialog" aria-hidden="true"></div>
  </div>

  <p class="muted">
    Notes: This visualization is a data-driven summary and not legal advice. Use the linked sources for verification and traceability.
  </p>
</div>

<!-- D3 + TopoJSON from CDN -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

<script>
(async function () {
  const tooltip = document.getElementById("tooltip");
  const chart = document.getElementById("chart");

  // 1) Load your dataset (local file)
  const data = await fetch("./csrd_issb_gri_waste_circular_frameworks_iso.json").then(r => r.json());

  // Index by ISO numeric (3-digit string), because world-atlas uses numeric ids for country features.
  const index = new Map(data.map(d => [String(d.ISO_N3).padStart(3, "0"), d]));

  // 2) Load world geometry (TopoJSON) from CDN
  const world = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r => r.json());
  const countries = topojson.feature(world, world.objects.countries).features;

  // 3) Set up SVG
  const width = 1100, height = 560;
  const svg = d3.select(chart).append("svg")
    .attr("viewBox", `0 0 ${width} ${height}`);

  const projection = d3.geoNaturalEarth1().fitSize([width, height], { type: "Sphere" });
  const path = d3.geoPath(projection);

  const color = (wfType) => {
    switch (wfType) {
      case "EU_directive": return "#16a34a";
      case "national_equivalent": return "#f59e0b";
      case "partial": return "#60a5fa";
      case "strategy_only": return "#60a5fa";
      case "none": return "#d1d5db";
      default: return "#e5e7eb";
    }
  };

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;'}[c]));
  }

  function makeTooltipHtml(d) {
    // Audit-safe wording: factual, classification explicitly labeled as dataset field.
    const waste = d.WasteFramework_type || "unknown";
    const circ = d.CircularEconomyFramework_type || "unknown";
    const issb = d.ISSB_status || "unknown";

    const wfSrc = d.WasteFramework_source ? `<div class="links"><span class="k">Waste source:</span><br><a href="${escapeHtml(d.WasteFramework_source)}" target="_blank" rel="noopener">${escapeHtml(d.WasteFramework_source)}</a></div>` : "";
    const ceSrc = d.CircularEconomyFramework_source ? `<div class="links" style="margin-top:6px;"><span class="k">Circular source:</span><br><a href="${escapeHtml(d.CircularEconomyFramework_source)}" target="_blank" rel="noopener">${escapeHtml(d.CircularEconomyFramework_source)}</a></div>` : "";
    const issbSrc = d.ISSB_source ? `<div class="links" style="margin-top:6px;"><span class="k">ISSB source:</span><br><a href="${escapeHtml(d.ISSB_source)}" target="_blank" rel="noopener">${escapeHtml(d.ISSB_source)}</a></div>` : "";

    return `
      <div class="title">${escapeHtml(d.Country)} <span style="opacity:.75; font-weight:600;">(${escapeHtml(d.ISO2 || "")})</span></div>
      <div class="row"><div class="k">Waste framework type</div><div class="v">${escapeHtml(waste)}</div></div>
      <div class="row"><div class="k">Circular framework type</div><div class="v">${escapeHtml(circ)}</div></div>
      <div class="row"><div class="k">ISSB status</div><div class="v">${escapeHtml(issb)}</div></div>
      <div class="row"><div class="k">GRI</div><div class="v">voluntary standard</div></div>
      ${wfSrc}${ceSrc}${issbSrc}
      <div class="muted">Classification fields reflect this dataset’s taxonomy; verify using linked primary sources where provided.</div>
    `;
  }

  function showTooltip(evt, html) {
    tooltip.innerHTML = html;
    tooltip.style.display = "block";
    tooltip.setAttribute("aria-hidden", "false");
    moveTooltip(evt);
  }

  function moveTooltip(evt) {
    const pad = 12;
    const rect = chart.getBoundingClientRect();
    const x = evt.clientX - rect.left + pad;
    const y = evt.clientY - rect.top + pad;

    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
  }

  function hideTooltip() {
    tooltip.style.display = "none";
    tooltip.setAttribute("aria-hidden", "true");
  }

  // 4) Draw map
  svg.append("path").datum({ type: "Sphere" })
    .attr("d", path)
    .attr("fill", "#f9fafb");

  svg.append("g")
    .selectAll("path")
    .data(countries)
    .join("path")
      .attr("class", "country")
      .attr("fill", f => {
        const id = String(f.id).padStart(3, "0");
        const d = index.get(id);
        return d ? color(d.WasteFramework_type) : "#e5e7eb";
      })
      .attr("d", path)
      .on("mousemove", function (evt) { moveTooltip(evt); })
      .on("mouseenter", function (evt, f) {
        const id = String(f.id).padStart(3, "0");
        const d = index.get(id);
        if (!d) return;
        showTooltip(evt, makeTooltipHtml(d));
      })
      .on("mouseleave", hideTooltip);

})();
</script>
</body>
</html>
